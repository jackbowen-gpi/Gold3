{% extends "standard.html" %}

{% block extra_head %}
<style type="text/css">
  .notification-test-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
  
  .test-section {
    margin-bottom: 30px;
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 5px;
    background-color: #f9f9f9;
  }
  
  .test-section h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 5px;
  }
  
  .test-button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
    font-size: 14px;
    transition: background-color 0.3s;
  }
  
  .test-button:hover {
    background-color: #45a049;
  }
  
  .test-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }
  
  .result-message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 4px;
    font-weight: bold;
  }
  
  .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .info-box {
    background-color: #e7f3ff;
    border: 1px solid #b3d7ff;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .code-example {
    background-color: #f4f4f4;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    margin: 10px 0;
  }
</style>

<script type="text/javascript">
// Modern JavaScript for notification testing
function testNotification(type) {
    const button = document.querySelector(`[data-type="${type}"]`);
    const resultDiv = document.getElementById(`result-${type}`);
    
    // Disable button and show loading
    button.disabled = true;
    button.textContent = 'Sending...';
    resultDiv.innerHTML = '';
    
    // Send AJAX request
    fetch('/accounts/test-notification/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        // Show result
        resultDiv.innerHTML = `
            <div class="result-message ${data.success ? 'success' : 'error'}">
                ${data.message}
            </div>
        `;
        
        // Re-enable button
        button.disabled = false;
        button.textContent = button.getAttribute('data-original-text');
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="result-message error">
                Network error: ${error.message}
            </div>
        `;
        
        // Re-enable button
        button.disabled = false;
        button.textContent = button.getAttribute('data-original-text');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Store original button text for all buttons
    const buttons = document.querySelectorAll('.test-button');
    buttons.forEach(button => {
        button.setAttribute('data-original-text', button.textContent);
    });
});
</script>
{% endblock %}

{% block body %}
<div class="notification-test-container">
    <h1>üîî Windows Notification Test Page</h1>
    
    <div class="info-box">
        <strong>‚ÑπÔ∏è About This Test Page:</strong><br>
        This page tests the migrated Windows notification system that replaced the old Growl protocol. 
        Click the buttons below to test different notification scenarios. Notifications will appear 
        as Windows toast notifications in the bottom-right corner of your screen.
        <br><br>
        <strong>User:</strong> {{ user.username }} | <strong>Authenticated:</strong> {% if user.is_authenticated %}Yes{% else %}No{% endif %}
    </div>

    <!-- Direct Windows Manager Tests -->
    <div class="test-section">
        <h3>üîß Direct Windows Manager Tests</h3>
        <p>These test the <code>WindowsNotificationManager</code> class directly.</p>
        
        <button class="test-button" data-type="direct" onclick="testNotification('direct')">
            Test Direct Windows Notification
        </button>
        
        <div class="code-example">
mgr = WindowsNotificationManager()
mgr.send_notification(title="Test", message="Message", duration=5)
        </div>
        <div id="result-direct"></div>
    </div>

    <!-- UserProfile.growl_at Tests -->
    <div class="test-section">
        <h3>üë§ UserProfile.growl_at() Tests</h3>
        <p>These test the migrated <code>user.profile.growl_at()</code> method that now uses Windows notifications.</p>
        
        <button class="test-button" data-type="user_profile" onclick="testNotification('user_profile')">
            Test user.profile.growl_at()
        </button>
        
        <button class="test-button" data-type="user_profile_sticky" onclick="testNotification('user_profile_sticky')">
            Test Sticky Notification
        </button>
        
        <div class="code-example">
user.profile.growl_at("Title", "Description", sticky=False)
user.profile.growl_at("Title", "Description", sticky=True)
        </div>
        <div id="result-user_profile"></div>
        <div id="result-user_profile_sticky"></div>
    </div>

    <!-- Notification Manager Tests -->
    <div class="test-section">
        <h3>üì® Notification Manager Tests</h3>
        <p>These test the <code>send_user_notification()</code> function from the notification manager.</p>
        
        <button class="test-button" data-type="notification_manager" onclick="testNotification('notification_manager')">
            Test Notification Manager
        </button>
        
        <div class="code-example">
send_user_notification(user_profile=profile, title="Title", description="Message")
        </div>
        <div id="result-notification_manager"></div>
    </div>

    <!-- Real-World Scenario Tests -->
    <div class="test-section">
        <h3>üè≠ Real-World Scenario Tests</h3>
        <p>These simulate the actual notifications your GOLD manufacturing system sends.</p>
        
        <button class="test-button" data-type="code_change_simulation" onclick="testNotification('code_change_simulation')">
            Simulate bin/growl_code_changes.py
        </button>
        
        <button class="test-button" data-type="intercom_simulation" onclick="testNotification('intercom_simulation')">
            Simulate bin/growl_intercom.py
        </button>
        
        <div class="code-example">
# Code changes script:
user.profile.growl_at("GOLD Change Announcement", change.change, 
                     pref_field="growl_hear_gold_changes")

# Intercom script:
user.profile.growl_at("ANNOUNCEMENT", message, sticky=True)
        </div>
        <div id="result-code_change_simulation"></div>
        <div id="result-intercom_simulation"></div>
    </div>

    <!-- Migration Info -->
    <div class="test-section">
        <h3>üîÑ Migration Information</h3>
        <p><strong>What Changed:</strong></p>
        <ul>
            <li>‚úÖ Old Growl protocol (<code>gntp</code>) ‚Üí Windows toast notifications (<code>win10toast</code>)</li>
            <li>‚úÖ Network-based notifications ‚Üí Local Windows notifications</li>
            <li>‚úÖ All existing <code>user.profile.growl_at()</code> calls work unchanged</li>
            <li>‚úÖ User preferences (<code>growl_hear_*</code> fields) still respected</li>
            <li>‚úÖ Compatible with Windows 10 and Windows 11</li>
        </ul>
        
        <p><strong>Files Updated:</strong></p>
        <ul>
            <li><code>gchub_db/apps/accounts/models.py</code> - UserProfile.growl_at() method</li>
            <li><code>requirements.txt</code> - Replaced gntp==1.0.3 with win10toast==0.9</li>
            <li><code>local_settings.py</code> - Removed gntp configuration</li>
        </ul>
    </div>
</div>
{% endblock %}

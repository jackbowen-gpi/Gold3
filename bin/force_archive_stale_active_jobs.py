#!/usr/bin/env python
"""Archive jobs with no activity, move symlinks to Archive dir."""

import time
from datetime import timedelta

# Setup the Django environment
import bin_functions

bin_functions.setup_paths()
from gchub_db.apps.workflow.models import Job

# Back to the ordinary imports
from gchub_db.includes import fs_api

# Jobs with no activity for more than this number of days will be archived.
ARCHIVAL_CUTOFF_DATE = 180
# Jobs with no activity that are complete for more than this number
# of days will be archived.
COMPLETE_CUTOFF_DATE = 120

JOB_SET = (
    370,
    41195,
    48380,
    49611,
    50039,
    50425,
    54500,
    55516,
    55585,
    55620,
    55732,
    55803,
    55805,
    55806,
    55807,
    55808,
    55848,
    55876,
    55901,
    55957,
    56162,
    56165,
    56447,
    56469,
    56547,
    56625,
    56730,
    56815,
    56927,
    56938,
    56997,
    57102,
    57249,
    57302,
    57351,
    57443,
    57444,
    57445,
    57446,
    57447,
    57554,
    57648,
    57672,
    57701,
    57718,
    57724,
    57783,
    57801,
    57807,
    57818,
    57840,
    57841,
    57896,
    57897,
    57942,
    57945,
    57949,
    57956,
    57958,
    57991,
    57996,
    57997,
    58019,
    58028,
    58031,
    58041,
    58042,
    58045,
    58046,
    58074,
    58082,
    58097,
    58100,
    58110,
    58145,
    58175,
    58177,
    58178,
    58182,
    58196,
    58206,
    58208,
    58215,
    58216,
    58218,
    58220,
    58221,
    58222,
    58223,
    58224,
    58227,
    58233,
    58235,
    58236,
    58239,
    58241,
    58242,
    58243,
    58244,
    58246,
    58247,
    58249,
    58250,
    58258,
    58260,
    58261,
    58267,
    58271,
    58287,
    58298,
    58312,
    58323,
    58327,
    58352,
    58358,
    58366,
    58369,
    58378,
    58386,
    58387,
    58389,
    58390,
    58395,
    58400,
    58404,
    58407,
    58412,
    58419,
    58422,
    58426,
    58428,
    58431,
    58432,
    58434,
    58436,
    58438,
    58443,
    58444,
    58445,
    58451,
    58453,
    58472,
    58473,
    58474,
    58475,
    58476,
    58477,
    58478,
    58479,
    58486,
    58487,
    58494,
    58501,
    58503,
    58504,
    58506,
    58508,
    58509,
    58510,
    58511,
    58513,
    58514,
    58515,
    58516,
    58517,
    58518,
    58519,
    58523,
    58524,
    58528,
    58529,
    58545,
    58547,
    58549,
    58553,
    58554,
    58556,
    58557,
    58562,
    58564,
    58567,
    58568,
    58570,
    58573,
    58574,
    58580,
    58584,
    58587,
    58589,
    58590,
    58592,
    58593,
    58596,
    58597,
    58598,
    58599,
    58610,
    58611,
    58614,
    58615,
    58616,
    58617,
    58619,
    58622,
    58626,
    58629,
    58634,
    58636,
    58643,
    58645,
    58646,
    58647,
    58649,
    58651,
    58652,
    58653,
    58656,
    58657,
    58658,
    58659,
    58660,
    58662,
    58664,
    58665,
    58669,
    58670,
    58671,
    58673,
    58674,
    58675,
    58676,
    58677,
    58678,
    58679,
    58680,
    58682,
    58683,
    58685,
    58686,
    58688,
    58689,
    58690,
    58691,
    58692,
    58693,
    58697,
    58698,
    58699,
    58700,
    58701,
    58702,
    58703,
    58706,
    58709,
    58710,
    58711,
    58713,
    58714,
    58715,
    58716,
    58717,
    58728,
    58734,
    58735,
    58736,
    58737,
    58739,
    58740,
    58741,
    58742,
    58744,
    58745,
    58748,
    58751,
    58752,
    58753,
    58754,
    58755,
    58757,
    58758,
    58760,
    58761,
    58762,
    58764,
    58766,
    58767,
    58768,
    58769,
    58770,
    58771,
    58772,
    58773,
    58775,
    58776,
    58778,
    58779,
    58780,
    58781,
    58784,
    58785,
    58786,
    58789,
    58791,
    58792,
    58793,
    58795,
    58801,
    58802,
    58803,
    58804,
    58805,
    58806,
    58807,
    58808,
    58810,
    58811,
    58812,
    58817,
    58818,
    58819,
    58820,
    58821,
    58823,
    58824,
    58828,
    58829,
    58830,
    58831,
    58832,
    58833,
    58834,
    58835,
    58836,
    58837,
    58838,
    58839,
    58840,
    58841,
    58842,
    58843,
    58844,
    58845,
    58846,
    58847,
    58848,
    58850,
    58851,
    58853,
    58855,
    58856,
    58857,
    58861,
    58862,
    58864,
    58867,
    58870,
    58871,
    58872,
    58873,
    58874,
    58877,
    58878,
    58879,
    58880,
    58881,
    58884,
    58886,
    58889,
    58892,
    58897,
    58898,
    58902,
    58903,
    58905,
    58906,
    58908,
    58909,
    58910,
    58913,
    58914,
    58915,
    58916,
    58917,
    58918,
    58919,
    58921,
    58922,
    58923,
    58928,
    58929,
    58930,
    58932,
    58933,
    58934,
    58935,
    58938,
    58939,
    58940,
    58941,
    58942,
    58945,
    58946,
    58947,
    58948,
    58949,
    58950,
    58951,
    58954,
    58956,
    58959,
    58962,
    58963,
    58967,
    58969,
    58970,
    58971,
    58972,
    58974,
    58978,
    58979,
    58980,
    58982,
    58983,
    58984,
    58985,
    58986,
    58994,
    58997,
    58998,
    58999,
    59001,
    59002,
    59003,
    59004,
    59008,
    59011,
    59012,
    59017,
    59018,
    59026,
    59027,
    59030,
    59033,
    59034,
    59035,
    59038,
    59039,
    59041,
    59042,
    59043,
    59044,
    59045,
    59046,
    59048,
    59049,
    59050,
    59051,
    59052,
    59055,
    59056,
    59058,
    59059,
    59061,
    59062,
    59063,
    59066,
    59067,
    59068,
    59069,
    59070,
    59071,
    59078,
    59079,
    59080,
    59081,
    59083,
    59084,
    59086,
    59088,
    59089,
    59090,
    59093,
    59094,
    59095,
    59096,
    59099,
    59100,
    59101,
    59102,
    59103,
    59104,
    59105,
    59106,
    59107,
    59108,
    59109,
    59110,
    59111,
    59112,
    59113,
    59114,
    59115,
    59116,
    59117,
    59118,
    59123,
    59124,
    59125,
    59126,
    59127,
    59128,
    59129,
    59131,
    59133,
    59140,
    59141,
    59144,
    59145,
    59147,
    59148,
    59149,
    59151,
    59152,
    59153,
    59154,
    59155,
    59156,
    59157,
    59158,
    59159,
    59160,
    59164,
    59170,
    59171,
    59172,
    59175,
    59176,
    59177,
    59178,
    59179,
    59182,
    59183,
    59185,
    59186,
    59187,
    59188,
    59189,
    59190,
    59193,
    59194,
    59195,
    59196,
    59198,
    59199,
    59200,
    59201,
    59204,
    59205,
    59206,
    59207,
    59210,
    59211,
    59212,
    59214,
    59215,
    59217,
    59219,
    59222,
    59223,
    59224,
    59228,
    59229,
    59230,
    59231,
    59232,
    59234,
    59237,
    59241,
    59242,
    59243,
    59245,
    59246,
    59248,
    59249,
    59250,
    59251,
    59252,
    59253,
    59254,
    59256,
    59259,
    59260,
    59261,
    59262,
    59264,
    59265,
    59266,
    59267,
    59268,
    59272,
    59274,
    59276,
    59277,
    59278,
    59279,
    59280,
    59282,
    59283,
    59285,
    59288,
    59290,
    59291,
    59292,
    59295,
    59296,
    59298,
    59300,
    59301,
    59302,
    59303,
    59304,
    59305,
    59306,
    59307,
    59310,
    59311,
    59313,
    59314,
    59315,
    59321,
    59322,
    59324,
    59325,
    59327,
    59329,
    59330,
    59332,
    59333,
    59337,
    59339,
    59340,
    59341,
    59343,
    59344,
    59345,
    59346,
    59348,
    59351,
    59356,
    59357,
    59360,
    59361,
    59363,
    59364,
    59365,
    59369,
    59370,
    59373,
    59374,
    59375,
    59376,
    59377,
    59379,
    59382,
    59383,
    59386,
    59387,
    59388,
    59390,
    59395,
    59396,
    59397,
    59398,
    59399,
    59400,
    59404,
    59405,
    59406,
    59407,
    59409,
    59411,
    59413,
    59417,
    59418,
    59419,
    59420,
    59421,
    59424,
    59425,
    59426,
    59427,
    59428,
    59429,
    59430,
    59432,
    59433,
    59435,
    59436,
    59438,
    59439,
    59442,
    59446,
    59447,
    59449,
    59450,
    59457,
    59458,
    59462,
    59463,
    59464,
    59466,
    59468,
    59469,
    59470,
    59471,
    59473,
    59474,
    59475,
    59476,
    59478,
    59480,
    59481,
    59483,
    59487,
    59489,
    59497,
    59498,
    59500,
    59501,
    59502,
    59503,
    59504,
    59505,
    59506,
    59507,
    59508,
    59510,
    59511,
    59512,
    59513,
    59514,
    59515,
    59516,
    59517,
    59518,
    59522,
    59523,
    59524,
    59525,
    59527,
    59528,
    59529,
    59530,
    59531,
    59532,
    59533,
    59535,
    59536,
    59537,
    59538,
    59539,
    59540,
    59543,
    59544,
    59545,
    59546,
    59547,
    59551,
    59552,
    59554,
    59556,
    59560,
    59562,
    59563,
    59566,
    59572,
    59573,
    59576,
    59581,
    59582,
    59585,
    59586,
    59587,
    59588,
    59589,
    59590,
    59591,
    59592,
    59593,
    59595,
    59598,
    59599,
    59604,
    59606,
    59607,
    59609,
    59610,
    59611,
    59612,
    59613,
    59617,
    59618,
    59622,
    59623,
    59626,
    59627,
    59628,
    59629,
    59631,
    59632,
    59642,
    59644,
    59645,
    59651,
    59653,
    59658,
    59659,
    59660,
    59661,
    59662,
    59663,
    59664,
    59665,
    59667,
    59668,
    59669,
    59671,
    99999,
)

print("set:", len(JOB_SET))


def main():
    """Entry point: archive the listed JOB_SET jobs when they meet archival criteria."""
    # jobs = Job.objects.filter(archive_disc='', workflow__name="Foodservice").order_by('id')
    jobs = Job.objects.filter(id__in=JOB_SET).order_by("id")
    from django.utils import timezone

    archival_cutoff_date = timezone.now() - timedelta(days=ARCHIVAL_CUTOFF_DATE)
    complete_cutoff_date = timezone.now() - timedelta(days=COMPLETE_CUTOFF_DATE)
    print("Cutoff date:", archival_cutoff_date)

    print("jobs:", jobs.count())

    counter = 0
    for job in jobs:
        last_joblog = job.job_set.all().order_by("-event_time")
        if last_joblog:
            last_joblog_date = last_joblog[0].event_time
            if last_joblog_date < archival_cutoff_date or (last_joblog_date < complete_cutoff_date and job.status == "Complete"):
                print("Archiving", job)
                try:
                    job.delete_folder_symlink()
                except fs_api.NoResultsFound:
                    pass
                print(" - Symlink deleted.")
                job.archive_disc = "1"
                job.save()
                print(" - Entry saved.")
                job.create_folder_symlink(force_archive=True)
                print(" - Symlink created.")
                job.lock_folder()
                counter += 1
                time.sleep(0.1)
                counter += 1
    print("Archiving of %d jobs is complete." % counter)


if __name__ == "__main__":
    main()
